<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <title>Preavaluació</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://alcdn.msauth.net">
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --bd:#e7e7ea; --text:#111; --muted:#667085;
      --primary:#0a6cf1; --shadow:0 10px 30px rgba(16,24,40,.08);
      --focus: 0 0 0 3px rgba(10,108,241,.25);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
    a{color:var(--primary)}
    .hidden{display:none!important}

    /* HERO (pre-login) */
    .hero{position:relative;min-height:82vh;display:grid;place-items:center;padding:24px;
      background:linear-gradient(120deg,#0e6efd 0%, #34b3ff 100%);color:#fff;overflow:hidden}
    .hero .container{max-width:980px;display:grid;grid-template-columns:1fr;gap:28px;align-items:center}
    .hero h1{margin:0 0 6px;font-size:clamp(28px,5vw,54px);line-height:1.05;text-shadow:0 6px 22px rgba(0,0,0,.18)}
    .hero p{margin:.2rem 0 1.4rem;font-size:clamp(16px,2.5vw,19px);opacity:.95}
    .hero .cta{display:inline-flex;align-items:center;gap:10px;padding:12px 18px;border-radius:12px;background:#fff;color:#0b57d0;border:0;cursor:pointer;font-weight:600;box-shadow:var(--shadow)}
    .hero .cta:focus{outline:none;box-shadow:var(--focus)}
    .hero small{opacity:.85}

    /* APP BAR (post-login) */
    .appbar{position:sticky;top:0;z-index:50;background:#ffffffd9;backdrop-filter:blur(6px);
      border-bottom:1px solid var(--bd);box-shadow:0 6px 18px rgba(16,24,40,.06)}
    .appbar-inner{max-width:980px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:10px 16px}
    .who{color:#334155;font-size:14px}
    .logout{background:#fff;border:1px solid var(--bd);border-radius:10px;padding:8px 12px;cursor:pointer}
    .logout:hover{background:#f8f9fb}

    /* APP */
    .wrap{max-width:900px;margin:24px auto 32px;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;box-shadow:var(--shadow);padding:18px}
    .muted{color:var(--muted)}

    /* PROGRESS */
    .progress{position:relative;background:#eef2ff;border-radius:999px;height:12px;overflow:hidden}
    .progress>.bar{height:100%;width:calc(var(--pct,0)*1%);background:linear-gradient(90deg,#0e6efd,#34b3ff);transition:width .35s ease}
    .progress-label{margin-top:8px;font-size:12px;color:var(--muted)}

    /* FORM */
    fieldset{border:1px solid var(--bd);border-radius:12px;padding:14px;margin:14px 0}
    legend{padding:0 6px}
    label{display:block;font-weight:600;margin:8px 0 6px}
    select{width:100%;padding:10px 12px;border:1px solid #cfd4dc;border-radius:10px;background:#fff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .chips{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 0}
    .chip{background:#f2f4f7;border:1px solid var(--bd);padding:6px 10px;border-radius:999px;font-size:12px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #1f2937;background:#111827;color:#fff;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .ok{color:#0a7c2f}.err{color:#b00020}

    .actions{display:flex;gap:10px;margin-top:10px}
  </style>
</head>
<body>

  <!-- Portada (sense barra de progrés) -->
  <section class="hero" id="hero">
    <div class="container">
      <div>
        <h1>Preavaluació<br><span style="opacity:.92;font-weight:600;">1r de SMX / DAM</span></h1>
        <p>Inicia sessió per accedir a la preavaluació. Et mostrarem només els teus alumnes i mòduls.</p>
        <button id="btnStart" class="cta">Inicia ara</button>
        <p class="muted"><small>Cal compte del centre (Microsoft 365).</small></p>
      </div>
    </div>
  </section>

  <!-- Barra superior amb email + Tanca sessió (només post-login) -->
  <div class="appbar hidden" id="appbar">
    <div class="appbar-inner">
      <span class="who" id="whoami">—</span>
      <button class="logout" id="btnLogout" title="Tanca la sessió">Tanca sessió</button>
    </div>
  </div>

  <!-- App -->
  <div class="wrap hidden" id="app">
    <div class="card">
      <div>
        <div class="progress" aria-hidden="true"><div class="bar" id="topBar" style="--pct:10"></div></div>
        <div class="progress-label" id="topLabel">Pàgina 1 de 10</div>
      </div>

      <!-- PAS 1: Selecciona alumne -->
      <section id="step1">
        <h2 style="margin:14px 0 6px">Pas 1 · Tria alumne</h2>
        <fieldset>
          <legend>Alumne</legend>
          <label for="alumneSel">Selecciona un alumne</label>
          <select id="alumneSel"></select>
          <p id="noData" class="err" style="display:none;margin:.6rem 0 0;">
            No tens cap alumne assignat (revisa <b>Assignacions</b> › <code>prof_email</code>).
          </p>
        </fieldset>
        <div class="chips" aria-live="polite">
          <span class="chip" id="chipAlumne">Alumne: —</span>
        </div>
        <div class="actions">
          <button class="btn" id="goStep2" disabled>Següent</button>
          <span id="status1" class="muted"></span>
        </div>
      </section>

      <!-- PAS 2: Selecciona mòdul (filtrat pel pas 1) -->
      <section id="step2" class="hidden">
        <h2 style="margin:14px 0 6px">Pas 2 · Tria mòdul</h2>
        <fieldset>
          <legend>Mòdul</legend>
          <label for="modulSel">Selecciona un mòdul del grup de l'alumne</label>
          <select id="modulSel"></select>
        </fieldset>
        <div class="chips" aria-live="polite">
          <span class="chip" id="chipAlumne2">Alumne: —</span>
          <span class="chip" id="chipModul">Mòdul: —</span>
        </div>
        <div class="actions">
          <button class="btn" id="backStep1">Enrere</button>
          <button class="btn" id="btnContinue" disabled>Continua</button>
          <span id="status2" class="muted"></span>
        </div>
      </section>

    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const path = window.location.pathname.endsWith(".html")
  ? window.location.pathname
  : (window.location.pathname.endsWith("/") ? window.location.pathname : window.location.pathname + "/");
const redirectGuess = window.location.origin + path;

const config = {
  clientId: "1892e1b0-6724-4cfe-b0aa-83d746e755e8",
  tenantId: "f6fbd66a-02b9-4804-8f74-b16600cf5e00",
  redirectUri: redirectGuess,
  useSharePointSite: false,
  sharePoint: { hostname: "ELTEUTENANT.sharepoint.com", sitePath: "/sites/ElMeuSite" },
  refsFilePath: "/tutoria/Preavaluacio/referencies.xlsx",
  refsTables: { alumnes: "Alumnes", assign: "Assignacions" }
};
const PROG_TOTAL = 10;
/* ===================== */

const msalConfig = {
  auth: {
    clientId: config.clientId,
    authority: `https://login.microsoftonline.com/${config.tenantId}`,
    redirectUri: config.redirectUri
  },
  cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false }
};
const graphScopes = ["User.Read","Files.ReadWrite", ...(config.useSharePointSite?["Sites.ReadWrite.All"]:[])];
const msalApp = new msal.PublicClientApplication(msalConfig);

const $ = (id)=>document.getElementById(id);
const setProgress = (step)=>{
  const pct = Math.max(1, Math.min(PROG_TOTAL, step)) / PROG_TOTAL * 100;
  $("topBar").style.setProperty("--pct", pct);
  $("topLabel").textContent  = `Pàgina ${step} de ${PROG_TOTAL}`;
};
setProgress(1);

let currentUserEmail = null;
let alumnes=[], assignacions=[];

function resetUI(){
  $("app").classList.add("hidden");
  $("appbar").classList.add("hidden");
  $("hero").classList.remove("hidden");
  $("whoami").textContent = "—";
  $("alumneSel").innerHTML = "";
  $("modulSel").innerHTML = "";
  $("chipAlumne").textContent = "Alumne: —";
  $("chipAlumne2").textContent = "Alumne: —";
  $("chipModul").textContent  = "Mòdul: —";
  $("goStep2").disabled = true;
  $("btnContinue").disabled = true;
  showStep(1);
  setProgress(1);
}

function showStep(n){
  $("step1").classList.toggle("hidden", n!==1);
  $("step2").classList.toggle("hidden", n!==2);
  setProgress(n); // 1 o 2 de 10
}

async function getToken(){
  const req={ account: msalApp.getAllAccounts()[0], scopes: graphScopes };
  try{ return (await msalApp.acquireTokenSilent(req)).accessToken; }
  catch{ return (await msalApp.acquireTokenPopup({scopes:graphScopes})).accessToken; }
}
async function gfetch(url,opts={}){
  const token=await getToken();
  const r=await fetch(url,{...opts,headers:{ "Authorization":`Bearer ${token}`,"Content-Type":"application/json",...(opts.headers||{}) }});
  if(!r.ok){ throw new Error(await r.text() || (r.status+" error")); }
  return r.json();
}
function graphBase(){
  return config.useSharePointSite
    ? `https://graph.microsoft.com/v1.0/sites/${config.sharePoint.hostname}:${config.sharePoint.sitePath}:/drive`
    : "https://graph.microsoft.com/v1.0/me/drive";
}
function graphPathToFile(base,path){ return `${base}/root:${encodeURI(path)}:`; }

async function loadTableRows(filePath, tableName){
  const base=graphBase(); const fileUrl=graphPathToFile(base,filePath);
  const cols=await gfetch(`${fileUrl}/workbook/tables/${encodeURIComponent(tableName)}/columns`);
  const colNames=cols.value.map(c=>c.name);
  const rows=await gfetch(`${fileUrl}/workbook/tables/${encodeURIComponent(tableName)}/rows`);
  return { colNames, rows: rows.value.map(r=>r.values[0]) };
}
function requireColumns(actual, required, tableName){
  for(const c of required) if(!actual.includes(c)) throw new Error(`Falta la columna \"${c}\" a la taula ${tableName}.`);
}

function updateChips(){
  try{
    const a=$("alumneSel").value?JSON.parse($("alumneSel").value):{};
    const m=$("modulSel").value?JSON.parse($("modulSel").value):{};
    $("chipAlumne").textContent = "Alumne: " + (a.student_name||"—");
    $("chipAlumne2").textContent = "Alumne: " + (a.student_name||"—");
    $("chipModul").textContent  = "Mòdul: "  + (m.module_name||"—");
  }catch{}
}

function rebuildAlumnesForProfessor(){
  if(!alumnes.length || !assignacions.length) return;
  let source=alumnes;
  if(currentUserEmail){
    const pairs=new Set(assignacions.filter(x=>(x.prof_email||"").toLowerCase()===currentUserEmail).map(x=>`${x.course}||${x.group}`));
    source=alumnes.filter(a=>pairs.has(`${a.course}||${a.group}`));
  }
  $("alumneSel").innerHTML = source.map(a=>`<option value='${JSON.stringify(a)}'>${a.student_name}${a.student_id?" ("+a.student_id+")":""}</option>`).join("");
  const has = $("alumneSel").options.length>0;
  $("noData").style.display = has ? "none" : "block";
  if(has) $("alumneSel").selectedIndex=0;
  $("goStep2").disabled = !has;
  updateChips();
}

function rebuildModulsForAlumne(){
  const a = $("alumneSel").value?JSON.parse($("alumneSel").value):{};
  const mods = assignacions.filter(m=> m.course===a.course && m.group===a.group && (!currentUserEmail || (m.prof_email||"").toLowerCase()===currentUserEmail));
  $("modulSel").innerHTML = mods.map(m=>`<option value='${JSON.stringify(m)}'>${m.module_name}${m.module_code?" ("+m.module_code+")":""}</option>`).join("");
  $("btnContinue").disabled = $("modulSel").options.length===0;
  if($("modulSel").options.length>0) $("modulSel").selectedIndex=0;
  updateChips();
}

async function initData(){
  const A = await loadTableRows(config.refsFilePath, config.refsTables.alumnes);
  requireColumns(A.colNames, ["course","group","student_id","student_name","student_email"], "Alumnes");
  const ia=Object.fromEntries(A.colNames.map((n,i)=>[n,i]));
  alumnes=A.rows.map(v=>({course:v[ia.course],group:v[ia.group],student_id:v[ia.student_id],student_name:v[ia.student_name],student_email:v[ia.student_email]}));

  const S = await loadTableRows(config.refsFilePath, config.refsTables.assign);
  requireColumns(S.colNames, ["course","group","module_code","module_name","prof_email"], "Assignacions");
  const is=Object.fromEntries(S.colNames.map((n,i)=>[n,i]));
  assignacions=S.rows.map(v=>({course:v[is.course],group:v[is.group],module_code:v[is.module_code],module_name:v[is.module_name],prof_email:v[is.prof_email]}));

  rebuildAlumnesForProfessor();
  updateChips();
}

async function start(){
  try{
    $("btnStart").disabled=true;
    const res = await msalApp.loginPopup({ scopes: graphScopes, prompt: "select_account" });
    currentUserEmail = (res.account.username||"").toLowerCase();
    $("whoami").textContent = currentUserEmail;
    $("hero").classList.add("hidden");
    $("appbar").classList.remove("hidden");
    $("app").classList.remove("hidden");
    showStep(1);
    await initData();
  }catch(e){
    console.error(e);
    alert("No s'ha pogut iniciar sessió: " + e.message);
    $("btnStart").disabled=false;
  }
}

async function logout(){
  try{
    const acc = msalApp.getAllAccounts()[0];
    await msalApp.logoutPopup({ account: acc, postLogoutRedirectUri: config.redirectUri });
  }catch(e){
    console.warn("logoutPopup va fallar, netejo UI igualment", e);
  }finally{
    resetUI();
  }
}

// Events
$("btnStart").addEventListener("click", start);
$("btnLogout").addEventListener("click", logout);
$("alumneSel").addEventListener("change", ()=>{
  updateChips();
  $("goStep2").disabled = $("alumneSel").selectedIndex<0;
});
$("goStep2").addEventListener("click", ()=>{
  rebuildModulsForAlumne();
  showStep(2);
});
$("backStep1").addEventListener("click", ()=>{ showStep(1); });
$("modulSel").addEventListener("change", ()=>{
  $("btnContinue").disabled = $("modulSel").selectedIndex<0;
  updateChips();
});
$("btnContinue").addEventListener("click", ()=>{
  alert("Perfecte! Selecció guardada.\n(Quan vulguis, afegim la resta de passos.)");
});

// Autologin si hi ha sessió
msalApp.handleRedirectPromise().then(async ()=>{
  const acc=msalApp.getAllAccounts()[0];
  if(acc){
    currentUserEmail = (acc.username||"").toLowerCase();
    $("whoami").textContent = currentUserEmail;
    $("hero").classList.add("hidden");
    $("appbar").classList.remove("hidden");
    $("app").classList.remove("hidden");
    showStep(1);
    await initData();
  }
}).catch(e=>console.error(e));
</script>
</body>
</html>
