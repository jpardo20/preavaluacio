<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <title>Preavaluació</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://alcdn.msauth.net">
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --bd:#e7e7ea; --text:#111; --muted:#667085;
      --primary:#0a6cf1; --shadow:0 10px 30px rgba(16,24,40,.08);
      --focus: 0 0 0 3px rgba(10,108,241,.25);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
    a{color:var(--primary)} .hidden{display:none!important}
    .hero{position:relative;min-height:82vh;display:grid;place-items:center;padding:24px;
      background:linear-gradient(120deg,#0e6efd 0%, #34b3ff 100%);color:#fff;overflow:hidden}
    .hero .container{max-width:980px;display:grid;grid-template-columns:1fr;gap:28px;align-items:center}
    .hero h1{margin:0 0 6px;font-size:clamp(28px,5vw,54px);line-height:1.05;text-shadow:0 6px 22px rgba(0,0,0,.18)}
    .hero p{margin:.2rem 0 1.4rem;font-size:clamp(16px,2.5vw,19px);opacity:.95}
    .hero .cta{display:inline-flex;align-items:center;gap:10px;padding:12px 18px;border-radius:12px;background:#fff;color:#0b57d0;border:0;cursor:pointer;font-weight:600;box-shadow:var(--shadow)}
    .hero .cta:focus{outline:none;box-shadow:var(--focus)}
    .hero small{opacity:.85}
    .appbar{position:sticky;top:0;z-index:50;background:#ffffffd9;backdrop-filter:blur(6px);
      border-bottom:1px solid var(--bd);box-shadow:0 6px 18px rgba(16,24,40,.06)}
    .appbar-inner{max-width:980px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:10px 16px}
    .who{color:#334155;font-size:14px}
    .logout{background:#fff;border:1px solid var(--bd);border-radius:10px;padding:8px 12px;cursor:pointer}
    .logout:hover{background:#f8f9fb}
    .wrap{max-width:900px;margin:24px auto 32px;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;box-shadow:var(--shadow);padding:18px}
    .muted{color:var(--muted)}
    .progress{position:relative;background:#eef2ff;border-radius:999px;height:12px;overflow:hidden}
    .progress>.bar{height:100%;width:calc(var(--pct,0)*1%);background:linear-gradient(90deg,#0e6efd,#34b3ff);transition:width .35s ease}
    .progress-label{margin-top:8px;font-size:12px;color:var(--muted)}
    fieldset{border:1px solid var(--bd);border-radius:12px;padding:14px;margin:14px 0}
    legend{padding:0 6px} label{display:block;font-weight:600;margin:8px 0 6px}
    select{width:100%;padding:10px 12px;border:1px solid #cfd4dc;border-radius:10px;background:#fff}
    .chips{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 0}
    .chip{background:#f2f4f7;border:1px solid var(--bd);padding:6px 10px;border-radius:999px;font-size:12px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #1f2937;background:#111827;color:#fff;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .ok{color:#0a7c2f}.err{color:#b00020}
    .actions{display:flex;gap:10px;margin-top:10px}
    .toast{margin-top:8px;font-size:14px}
  </style>
</head>
<body>

  <!-- Portada -->
  <section class="hero" id="hero">
    <div class="container">
      <div>
        <h1>Preavaluació<br><span style="opacity:.92;font-weight:600;">1r de SMX / DAM</span></h1>
        <p>Inicia sessió per accedir a la preavaluació. Et mostrarem només els teus alumnes i mòduls.</p>
        <button id="btnStart" class="cta">Inicia ara</button>
        <p class="muted"><small>Cal compte del centre (Microsoft 365).</small></p>
      </div>
    </div>
  </section>

  <!-- Barra superior -->
  <div class="appbar hidden" id="appbar">
    <div class="appbar-inner">
      <span class="who" id="whoami">—</span>
      <button class="logout" id="btnLogout" title="Tanca la sessió">Tanca sessió</button>
    </div>
  </div>

  <!-- App -->
  <div class="wrap hidden" id="app">
    <div class="card">
      <div>
        <div class="progress" aria-hidden="true"><div class="bar" id="topBar" style="--pct:10"></div></div>
        <div class="progress-label" id="topLabel">Pàgina 1 de 10</div>
      </div>

      <!-- PAS 1 -->
      <section id="step1">
        <h2 style="margin:14px 0 6px">Pas 1 · Tria alumne</h2>
        <fieldset>
          <legend>Alumne</legend>
          <label for="alumneSel">Selecciona un alumne</label>
          <select id="alumneSel"></select>
          <p id="noData" class="err" style="display:none;margin:.6rem 0 0;">
            No tens cap alumne assignat (revisa <b>Assignacions</b> › <code>prof_email</code>).
          </p>
        </fieldset>
        <div class="chips" aria-live="polite">
          <span class="chip" id="chipAlumne">Alumne: —</span>
        </div>
        <div class="actions">
          <button class="btn" id="goStep2" disabled>Següent</button>
          <span id="status1" class="muted toast"></span>
        </div>
      </section>

      <!-- PAS 2 -->
      <section id="step2" class="hidden">
        <h2 style="margin:14px 0 6px">Pas 2 · Tria mòdul</h2>
        <fieldset>
          <legend>Mòdul</legend>
          <label for="modulSel">Selecciona un mòdul del grup de l'alumne</label>
          <select id="modulSel"></select>
        </fieldset>
        <div class="chips" aria-live="polite">
          <span class="chip" id="chipAlumne2">Alumne: —</span>
          <span class="chip" id="chipModul">Mòdul: —</span>
        </div>
        <div class="actions">
          <button class="btn" id="backStep1">Enrere</button>
          <button class="btn" id="btnContinue" disabled>Continua</button>
          <span id="status2" class="muted toast"></span>
        </div>
      </section>

    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const path = window.location.pathname.endsWith(".html")
  ? window.location.pathname
  : (window.location.pathname.endsWith("/") ? window.location.pathname : window.location.pathname + "/");
const redirectGuess = window.location.origin + path;

const config = {
  clientId: "1892e1b0-6724-4cfe-b0aa-83d746e755e8",
  tenantId: "f6fbd66a-02b9-4804-8f74-b16600cf5e00",
  redirectUri: redirectGuess,

  // ENLLAÇ COMPARTIT DEL TEU EXCEL (OneDrive, “Anyone in org with link can edit/view”)
    sharedLink: "https://gmqualitytechnologysl365-my.sharepoint.com/:x:/g/personal/jpardo20_digitechfp_com/IQCjtGM5iqDARr3Fh1LpzsB6AYE049kU-pr-WRdIIhaEA5g?e=xCr8B7",


  refsTables: { alumnes: "Alumnes", assign: "Assignacions" }
};
const PROG_TOTAL = 10;
/* ===================== */

const msalConfig = {
  auth: {
    clientId: config.clientId,
    authority: `https://login.microsoftonline.com/${config.tenantId}`,
    redirectUri: config.redirectUri
  },
  cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false }
};
const graphScopes = ["User.Read","Files.ReadWrite"]; // prou per a enllaç compartit

const msalApp = new msal.PublicClientApplication(msalConfig);
const $ = (id)=>document.getElementById(id);
const setProgress = (step)=>{
  const pct = Math.max(1, Math.min(PROG_TOTAL, step)) / PROG_TOTAL * 100;
  $("topBar").style.setProperty("--pct", pct);
  $("topLabel").textContent  = `Pàgina ${step} de ${PROG_TOTAL}`;
};
setProgress(1);

let currentUserEmail = null;
let alumnes=[], assignacions=[];
let workbookSessionId = null;
let driveBase = null; // https://graph.microsoft.com/v1.0/drives/{driveId}/items/{itemId}

/* ===== UI helpers ===== */
function showStep(n){ $("step1").classList.toggle("hidden", n!==1); $("step2").classList.toggle("hidden", n!==2); setProgress(n); }
function resetUI(){
  $("app").classList.add("hidden"); $("appbar").classList.add("hidden"); $("hero").classList.remove("hidden");
  $("whoami").textContent = "—"; $("alumneSel").innerHTML = ""; $("modulSel").innerHTML = "";
  $("chipAlumne").textContent = "Alumne: —"; $("chipAlumne2").textContent = "Alumne: —"; $("chipModul").textContent = "Mòdul: —";
  $("goStep2").disabled = true; $("btnContinue").disabled = true; workbookSessionId = null; driveBase = null; showStep(1); setProgress(1); statusMsg("");
}
function statusMsg(msg, where="status1", cls="muted"){ const el = $(where); if(!el) return; el.className = cls + " toast"; el.textContent = msg || ""; }

/* ===== Graph helpers ===== */
function base64UrlEncode(str){ return btoa(str).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
async function getToken(){
  const req={ account: msalApp.getAllAccounts()[0], scopes: graphScopes };
  try{ return (await msalApp.acquireTokenSilent(req)).accessToken; }
  catch{ return (await msalApp.acquireTokenPopup({scopes:graphScopes})).accessToken; }
}
async function gfetch(url,opts={}, useWorkbookHeader=true){
  const token=await getToken();
  const headers = { "Authorization":`Bearer ${token}`, "Content-Type":"application/json", ...(opts.headers||{}) };
  if(useWorkbookHeader && workbookSessionId){ headers["workbook-session-id"] = workbookSessionId; }
  const r=await fetch(url,{...opts,headers});
  if(!r.ok){
    let detail = ""; try{ detail = await r.text(); }catch{}
    const error = new Error(`HTTP ${r.status} ${r.statusText} :: ${detail}`); error.status = r.status; error.body = detail; throw error;
  }
  if(r.status===204) return null;
  return r.json();
}
function niceGraphError(e){
  let msg = e.message || String(e);
  try{
    const body = JSON.parse(e.body || "{}");
    if(body && body.error){
      const code = body.error.code || ""; const message = body.error.message || msg;
      if(e.status===404 || /ItemNotFound/i.test(code)){ msg = "No trobo el fitxer d'origen (404). Revisa l'enllaç compartit o els permisos."; }
      else if(e.status===403 || /accessDenied/i.test(code)){ msg = "No tens permisos per accedir al fitxer (403). Revisa la configuració de l'enllaç."; }
      else if(e.status===423 || /Locked/i.test(code)){ msg = "El fitxer està en ús (423). Tanca l'Excel i torna-ho a provar."; }
      else { msg = message; }
    }
  }catch{}
  return msg;
}

/* ===== Resolve shared link to /drives/{id}/items/{id} (AAD safe) ===== */
async function resolveSharedLinkBase(sharedLink){
  const enc = base64UrlEncode(sharedLink);
  const info = await gfetch(`https://graph.microsoft.com/v1.0/shares/u!${enc}/driveItem?$select=id,name,parentReference`,
    { method:"GET" }, false);
  const itemId = info.id;
  const driveId = info.parentReference && (info.parentReference.driveId || info.parentReference.id);
  if(!itemId || !driveId) throw new Error("No he pogut resoldre driveId/itemId des de l'enllaç compartit.");
  return `https://graph.microsoft.com/v1.0/drives/${driveId}/items/${itemId}`;
}

/* ===== Workbook helpers ===== */
async function ensureWorkbookSession(){
  if(workbookSessionId) return workbookSessionId;
  if(!driveBase) throw new Error("driveBase no inicialitzat.");
  try{
    const s = await gfetch(`${driveBase}/workbook/createSession`, { method:"POST", body: JSON.stringify({persistChanges:false}) }, false);
    workbookSessionId = s.id; return workbookSessionId;
  }catch(e){
    console.warn("No s'ha pogut crear la sessió de workbook:", e);
    workbookSessionId = null; return null;
  }
}
async function loadTableRows(tableName){
  if(!driveBase) throw new Error("driveBase no inicialitzat.");
  await ensureWorkbookSession();
  const cols = await gfetch(`${driveBase}/workbook/tables/${encodeURIComponent(tableName)}/columns`);
  const colNames = cols.value.map(c=>c.name);
  const rows = await gfetch(`${driveBase}/workbook/tables/${encodeURIComponent(tableName)}/rows`);
  return { colNames, rows: rows.value.map(r=>r.values[0]) };
}
function requireColumns(actual, required, tableName){ for(const c of required) if(!actual.includes(c)) throw new Error(`Falta la columna "${c}" a la taula ${tableName}.`); }

/* ===== Dades i UI ===== */
function updateChips(){
  try{
    const a=$("alumneSel").value?JSON.parse($("alumneSel").value):{};
    const m=$("modulSel").value?JSON.parse($("modulSel").value):{};
    $("chipAlumne").textContent = "Alumne: " + (a.student_name||"—");
    $("chipAlumne2").textContent = "Alumne: " + (a.student_name||"—");
    $("chipModul").textContent  = "Mòdul: "  + (m.module_name||"—");
  }catch{}
}
function rebuildAlumnesForProfessor(){
  if(!alumnes.length || !assignacions.length) return;
  let source=alumnes;
  if(currentUserEmail){
    const pairs=new Set(assignacions.filter(x=>(x.prof_email||"").toLowerCase()===currentUserEmail).map(x=>`${x.course}||${x.group}`));
    source=alumnes.filter(a=>pairs.has(`${a.course}||${a.group}`));
  }
  $("alumneSel").innerHTML = source.map(a=>`<option value='${JSON.stringify(a)}'>${a.student_name}${a.student_id? " ("+a.student_id+")": ""}</option>`).join("");
  const has = $("alumneSel").options.length>0;
  $("noData").style.display = has ? "none" : "block";
  if(has) $("alumneSel").selectedIndex=0;
  $("goStep2").disabled = !has;
  updateChips();
}
function rebuildModulsForAlumne(){
  const a = $("alumneSel").value?JSON.parse($("alumneSel").value):{};
  const mods = assignacions.filter(m=> m.course===a.course && m.group===a.group && (!currentUserEmail || (m.prof_email||"").toLowerCase()===currentUserEmail));
  $("modulSel").innerHTML = mods.map(m=>`<option value='${JSON.stringify(m)}'>${m.module_name}${m.module_code?" ("+m.module_code+")":""}</option>`).join("");
  $("btnContinue").disabled = $("modulSel").options.length===0;
  if($("modulSel").options.length>0) $("modulSel").selectedIndex=0;
  updateChips();
}

async function initData(){
  try{
    statusMsg("Resoldre enllaç compartit…","status1");
    driveBase = await resolveSharedLinkBase(config.sharedLink); // AAD compatible
    statusMsg("Carregant llistes d'Excel…","status1");
    const A = await loadTableRows(config.refsTables.alumnes);
    requireColumns(A.colNames, ["course","group","student_id","student_name","student_email"], "Alumnes");
    const ia=Object.fromEntries(A.colNames.map((n,i)=>[n,i]));
    alumnes=A.rows.map(v=>({course:v[ia.course],group:v[ia.group],student_id:v[ia.student_id],student_name:v[ia.student_name],student_email:v[ia.student_email]}));

    const S = await loadTableRows(config.refsTables.assign);
    requireColumns(S.colNames, ["course","group","module_code","module_name","prof_email"], "Assignacions");
    const is=Object.fromEntries(S.colNames.map((n,i)=>[n,i]));
    assignacions=S.rows.map(v=>({course:v[is.course],group:v[is.group],module_code:v[is.module_code],module_name:v[is.module_name],prof_email:v[is.prof_email]}));

    rebuildAlumnesForProfessor();
    updateChips();
    statusMsg("Llistes carregades.","status1","ok");
  }catch(e){
    console.error(e);
    const msg = niceGraphError(e);
    statusMsg(msg,"status1","err");
    alert("Error carregant dades: " + msg);
  }
}

/* ===== Flux login/logout ===== */
async function start(){
  try{
    $("btnStart").disabled=true;
    const res = await msalApp.loginPopup({ scopes: graphScopes, prompt: "select_account" });
    currentUserEmail = (res.account.username||"").toLowerCase();
    $("whoami").textContent = currentUserEmail;
    $("hero").classList.add("hidden");
    $("appbar").classList.remove("hidden");
    $("app").classList.remove("hidden");
    showStep(1);
    await initData();
  }catch(e){
    console.error(e);
    alert("No s'ha pogut iniciar sessió: " + e.message);
    $("btnStart").disabled=false;
  }
}
async function logout(){
  try{
    const acc = msalApp.getAllAccounts()[0];
    await msalApp.logoutPopup({ account: acc, postLogoutRedirectUri: config.redirectUri });
  }catch(e){
    console.warn("logoutPopup va fallar, netejo UI igualment", e);
  }finally{
    resetUI();
  }
}

/* ===== Events ===== */
$("btnStart").addEventListener("click", start);
$("btnLogout").addEventListener("click", logout);
$("alumneSel").addEventListener("change", ()=>{ updateChips(); $("goStep2").disabled = $("alumneSel").selectedIndex<0; });
$("goStep2").addEventListener("click", ()=>{ rebuildModulsForAlumne(); showStep(2); });
$("backStep1").addEventListener("click", ()=>{ showStep(1); });
$("modulSel").addEventListener("change", ()=>{ $("btnContinue").disabled = $("modulSel").selectedIndex<0; updateChips(); });
$("btnContinue").addEventListener("click", ()=>{ alert("Perfecte! Selecció guardada.\n(Quan vulguis, afegim la resta de passos.)"); });

// Autologin
msalApp.handleRedirectPromise().then(async ()=>{
  const acc=msalApp.getAllAccounts()[0];
  if(acc){
    currentUserEmail = (acc.username||"").toLowerCase();
    $("whoami").textContent = currentUserEmail;
    $("hero").classList.add("hidden");
    $("appbar").classList.remove("hidden");
    $("app").classList.remove("hidden");
    showStep(1);
    await initData();
  }
}).catch(e=>console.error(e));
</script>
</body>
</html>
